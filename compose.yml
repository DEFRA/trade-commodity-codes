services:
  localstack:
    image: localstack/localstack:3.0.2
    ports:
      - '4566:4566' # LocalStack Gateway
      - '4510-4559:4510-4559' # external services port range
    env_file:
      - 'compose/aws.env'
    environment:
      DEBUG: ${DEBUG:-1}
      LS_LOG: WARN # Localstack DEBUG Level
      SERVICES: s3,sqs,sns,cloudwatch
      LOCALSTACK_HOST: 127.0.0.1
    volumes:
      - localstack-data:/var/lib/localstack
      - ./compose/start-localstack.sh:/etc/localstack/init/ready.d/start-localstack.sh
    healthcheck:
      test: ['CMD', 'curl', 'localhost:4566']
      interval: 5s
      start_period: 5s
      retries: 3
    networks:
      - cdp-tenant

  postgres:
    image: postgres:16
    container_name: trade-commodity-codes-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: trade-commodity-codes
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
    networks:
      - cdp-tenant

  liquibase:
    image: liquibase/liquibase:4.32.0
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./changelog:/liquibase/changelog
    command: >
      --driver=org.postgresql.Driver
      --changelog-file=changelog/db.changelog.xml
      --url=jdbc:postgresql://postgres:5432/trade-commodity-codes
      --username=postgres
      --password=postgres
      update
    networks:
      - cdp-tenant

  trade-commodity-codes:
    build:
      context: .
      target: development
    ports:
      - '8085:8085'
      - '5005:5005' # Java debug port
    links:
      - 'localstack:localstack'
      - 'postgres:postgres'
    depends_on:
      localstack:
        condition: service_healthy
      postgres:
        condition: service_healthy
      liquibase:
        condition: service_completed_successfully
    volumes:
      - './changelog:/app/changelog'
    env_file:
      - 'compose/aws.env'
    environment:
      # Server
      PORT: 8085

      # Service Identity
      SERVICE_VERSION: 0.0.0-local
      ENVIRONMENT: local

      # Postgres
      POSTGRES_URI: jdbc:postgresql://postgres:5432/trade-commodity-codes
      POSTGRES_DATABASE: trade-commodity-codes

      # AWS (via LocalStack)
      LOCALSTACK_ENDPOINT: http://localstack:4566
      AWS_REGION: eu-west-2
      AWS_EMF_ENVIRONMENT: Local
      AWS_EMF_NAMESPACE: trade-commodity-codes
      AWS_EMF_SERVICE_TYPE: SpringBootApp
      AWS_EMF_WRITE_TO_STDOUT: true

      # Logging
      LOG_LEVEL: DEBUG

      # Metrics (disabled locally)
      ENABLE_METRICS: true

      # Spring profile (dev = exposes debugging actuator endpoints)
      SPRING_PROFILES_ACTIVE: local

      # Liquibase configuration for dev profile
      LIQUIBASE_CHANGELOG_PATH: changelog/db.changelog.xml

      # Java Debug (optional - uncomment to enable remote debugging)
      # JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    networks:
      - cdp-tenant
    # Note: No volume mounts for Java (requires rebuild for code changes)
    # For faster development, use 'mvn spring-boot:run' directly on host

################################################################################

volumes:
  localstack-data:
  postgres-data:

networks:
  cdp-tenant:
    driver: bridge
    name: cdp-tenant
