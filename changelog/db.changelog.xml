<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ============================================================================ -->
    <!-- Master PostgreSQL Consolidated Changelog -->
    <!-- Generated from existing SQL Server Liquibase scripts -->
    <!-- For ETL migration from SQL Server to PostgreSQL -->
    <!-- ============================================================================ -->

    <!-- 
    USAGE INSTRUCTIONS:
    
    1. Database Setup:
       - Ensure PostgreSQL 12+ is installed and running
       - Create target database: CREATE DATABASE commodity_db;
       - Configure database connection properties
    
    2. User Management (IMPORTANT - Do this BEFORE running permissions):
       - Create users according to your authentication method:
         * For Azure Managed Identity: CREATE USER "identity-name" FROM EXTERNAL PROVIDER;
         * For database auth: CREATE USER username WITH PASSWORD 'password';
         * For LDAP/AD: Configure according to your setup
       - Then uncomment role assignments in 05-permissions-changelog.xml
    
    3. Execution:
       - Run: liquibase update
       - Or run individual changelogs in the specified order
    
    4. Post-Migration:
       - Refresh materialized views: REFRESH MATERIALIZED VIEW mv_commodity_code_stats;
       - Run data validation checks
       - Test application connectivity with each role
    
    5. ETL Integration:
       - Use commodity_data_loader_role for ETL operations
       - Utilize fn_log_data_load() to track data loads
       - Use validation functions for data quality checks
    -->

    <!-- Include changelog files in execution order -->
    
    <!-- 1. Tables and Constraints -->
    <include file="changes/01-tables-changelog.xml" relativeToChangelogFile="true"/>
    
    <!-- 2. Functions (required before views that use them) -->
    <include file="changes/02-functions-changelog.xml" relativeToChangelogFile="true"/>
    
    <!-- 3. Views (depend on tables and functions) -->
    <include file="changes/03-views-changelog.xml" relativeToChangelogFile="true"/>
    
    <!-- 4. Additional Objects (triggers, types, sequences, etc.) -->
    <include file="changes/04-additional-objects-changelog.xml" relativeToChangelogFile="true"/>
    
    <!-- 5. Permissions (must be last to grant access to all objects) -->
<!--    <include file="changes/05-permissions-changelog.xml" relativeToChangelogFile="true"/>-->

<!--    &lt;!&ndash; Final validation and setup &ndash;&gt;-->
<!--    <changeSet id="postgresql-master-01-final-setup" author="consolidated-migration" runOnChange="true">-->
<!--        <sql dbms="postgresql" endDelimiter="/">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; Refresh materialized views-->
<!--            REFRESH MATERIALIZED VIEW mv_commodity_code_stats;-->

<!--            &#45;&#45; Create initial data load record for tracking-->
<!--            INSERT INTO data_load (loaded, file_name, table_name)-->
<!--            VALUES (CURRENT_TIMESTAMP, 'initial-postgresql-migration', 'migration_complete')-->
<!--            ON CONFLICT (table_name) DO NOTHING;-->

<!--            &#45;&#45; Generate initial database statistics-->
<!--            SELECT fn_get_database_statistics() AS initial_stats;-->
<!--            ]]>-->
<!--        </sql>-->
<!--    </changeSet>-->

<!--    &lt;!&ndash; Migration validation changelog &ndash;&gt;-->
<!--    <changeSet id="postgresql-master-02-migration-validation" author="consolidated-migration" runOnChange="true">-->
<!--        <sql dbms="postgresql" endDelimiter="/">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; Validate core tables exist and have data structure-->
<!--            DO $$-->
<!--            DECLARE-->
<!--                table_count INTEGER;-->
<!--                view_count INTEGER;-->
<!--                function_count INTEGER;-->
<!--                role_count INTEGER;-->
<!--            BEGIN-->
<!--                &#45;&#45; Count core tables-->
<!--                SELECT COUNT(*) INTO table_count-->
<!--                FROM information_schema.tables-->
<!--                WHERE table_schema = 'public'-->
<!--                AND table_type = 'BASE TABLE'-->
<!--                AND table_name IN (-->
<!--                    'certificates', 'commodity_nomenclature', 'species',-->
<!--                    'certification_requirement', 'certification_nomenclature',-->
<!--                    'commodity_class', 'commodity_eppo_variety', 'hmi_marketing',-->
<!--                    'inspection_responsibility', 'commodity_group', 'commodity_group_commodity',-->
<!--                    'article_72_commodities', 'commodity_configuration', 'commoditycode_attributes',-->
<!--                    'data_load'-->
<!--                );-->

<!--                &#45;&#45; Count views-->
<!--                SELECT COUNT(*) INTO view_count-->
<!--                FROM information_schema.views-->
<!--                WHERE table_schema = 'public'-->
<!--                AND table_name LIKE 'v_%';-->

<!--                &#45;&#45; Count functions-->
<!--                SELECT COUNT(*) INTO function_count-->
<!--                FROM information_schema.routines-->
<!--                WHERE routine_schema = 'public'-->
<!--                AND routine_type = 'FUNCTION'-->
<!--                AND routine_name LIKE 'fn_%';-->

<!--                &#45;&#45; Count roles-->
<!--                SELECT COUNT(*) INTO role_count-->
<!--                FROM pg_roles-->
<!--                WHERE rolname LIKE 'commodity_%';-->

<!--                &#45;&#45; Log validation results-->
<!--                RAISE NOTICE 'Migration Validation Results:';-->
<!--                RAISE NOTICE 'Tables created: % of 15 expected', table_count;-->
<!--                RAISE NOTICE 'Views created: %', view_count;-->
<!--                RAISE NOTICE 'Functions created: %', function_count;-->
<!--                RAISE NOTICE 'Roles created: %', role_count;-->

<!--                &#45;&#45; Validate minimum requirements-->
<!--                IF table_count < 15 THEN-->
<!--                    RAISE EXCEPTION 'Migration validation failed: Expected 15 tables, found %', table_count;-->
<!--                END IF;-->

<!--                IF view_count < 9 THEN-->
<!--                    RAISE WARNING 'Low view count: Expected 9+ views, found %', view_count;-->
<!--                END IF;-->

<!--                RAISE NOTICE 'Migration validation completed successfully!';-->
<!--            END-->
<!--            $$;-->
<!--            ]]>-->
<!--        </sql>-->
<!--     </changeSet>-->

</databaseChangeLog>