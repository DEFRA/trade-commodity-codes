<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ============================================================================ -->
    <!-- PostgreSQL Consolidated Permissions Changelog -->
    <!-- ============================================================================ -->

<!--    &lt;!&ndash; Create Database Roles &ndash;&gt;-->
<!--    <changeSet id="postgresql-permissions-01-create-roles" author="consolidated-migration">-->
<!--        <sql dbms="postgresql">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; Main service role for commodity code operations-->
<!--            CREATE ROLE commodity_service_role;-->
<!--            -->
<!--            &#45;&#45; Data loading role for ETL operations  -->
<!--            CREATE ROLE commodity_data_loader_role;-->
<!--            -->
<!--            &#45;&#45; Read-only role for reporting and analytics-->
<!--            CREATE ROLE commodity_readonly_role;-->
<!--            -->
<!--            &#45;&#45; Admin role for database management-->
<!--            CREATE ROLE commodity_admin_role;-->
<!--            ]]>-->
<!--        </sql>-->
<!--    </changeSet>-->

    <!-- Service Role - Table Permissions -->
    <changeSet id="postgresql-permissions-02-service-role-table-permissions" author="consolidated-migration">
        <sql dbms="postgresql">
            <![CDATA[
            -- SELECT permissions on all core tables
            GRANT SELECT ON certificates TO trade-commodity-codes;
            GRANT SELECT ON commodity_nomenclature TO trade-commodity-codes;
            GRANT SELECT ON species TO trade-commodity-codes;
            GRANT SELECT ON certification_requirement TO trade-commodity-codes;
            GRANT SELECT ON certification_nomenclature TO trade-commodity-codes;
            GRANT SELECT ON commodity_class TO trade-commodity-codes;
            GRANT SELECT ON commodity_eppo_variety TO trade-commodity-codes;
            GRANT SELECT ON hmi_marketing TO trade-commodity-codes;
            GRANT SELECT ON inspection_responsibility TO trade-commodity-codes;
            GRANT SELECT ON commodity_group TO trade-commodity-codes;
            GRANT SELECT ON commodity_group_commodity TO trade-commodity-codes;
            GRANT SELECT ON article_72_commodities TO trade-commodity-codes;
            GRANT SELECT ON commodity_configuration TO trade-commodity-codes;
            GRANT SELECT ON commoditycode_attributes TO trade-commodity-codes;
            GRANT SELECT ON data_load TO trade-commodity-codes;

            -- Limited UPDATE permissions for specific operational needs
            GRANT UPDATE ON hmi_marketing TO trade-commodity-codes;
            GRANT UPDATE ON inspection_responsibility TO trade-commodity-codes;
            GRANT UPDATE ON commodity_group TO trade-commodity-codes;
            GRANT UPDATE ON commodity_group_commodity TO trade-commodity-codes;
            GRANT UPDATE ON commoditycode_attributes TO trade-commodity-codes;
            ]]>
        </sql>
    </changeSet>

<!--    &lt;!&ndash; Data Loader Role - Table Permissions &ndash;&gt;-->
<!--    <changeSet id="postgresql-permissions-03-data-loader-role-table-permissions" author="consolidated-migration">-->
<!--        <sql dbms="postgresql">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; Full DML permissions on core data tables-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON certificates TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_nomenclature TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON species TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON certification_requirement TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON certification_nomenclature TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_class TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_eppo_variety TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON hmi_marketing TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON inspection_responsibility TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_group TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_group_commodity TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON article_72_commodities TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commodity_configuration TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON commoditycode_attributes TO commodity_data_loader_role;-->
<!--            GRANT SELECT, INSERT, UPDATE, DELETE ON data_load TO commodity_data_loader_role;-->
<!--            -->
<!--            &#45;&#45; Sequence permissions for auto-incrementing fields-->
<!--            GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO commodity_data_loader_role;-->
<!--            ]]>-->
<!--        </sql>-->
<!--    </changeSet>-->

<!--    &lt;!&ndash; Read-Only Role - Table Permissions &ndash;&gt;-->
<!--    <changeSet id="postgresql-permissions-04-readonly-role-table-permissions" author="consolidated-migration">-->
<!--        <sql dbms="postgresql">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; SELECT permissions only on all tables-->
<!--            GRANT SELECT ON certificates TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_nomenclature TO commodity_readonly_role;-->
<!--            GRANT SELECT ON species TO commodity_readonly_role;-->
<!--            GRANT SELECT ON certification_requirement TO commodity_readonly_role;-->
<!--            GRANT SELECT ON certification_nomenclature TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_class TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_eppo_variety TO commodity_readonly_role;-->
<!--            GRANT SELECT ON hmi_marketing TO commodity_readonly_role;-->
<!--            GRANT SELECT ON inspection_responsibility TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_group TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_group_commodity TO commodity_readonly_role;-->
<!--            GRANT SELECT ON article_72_commodities TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commodity_configuration TO commodity_readonly_role;-->
<!--            GRANT SELECT ON commoditycode_attributes TO commodity_readonly_role;-->
<!--            GRANT SELECT ON data_load TO commodity_readonly_role;-->
<!--            ]]>-->
<!--        </sql>-->
<!--     </changeSet>-->

<!--    &lt;!&ndash; Admin Role - Table Permissions &ndash;&gt;-->
<!--    <changeSet id="postgresql-permissions-05-admin-role-table-permissions" author="consolidated-migration">-->
<!--        <sql dbms="postgresql">-->
<!--            <![CDATA[-->
<!--            &#45;&#45; Full permissions on all tables-->
<!--            GRANT ALL PRIVILEGES ON certificates TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_nomenclature TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON species TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON certification_requirement TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON certification_nomenclature TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_class TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_eppo_variety TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON hmi_marketing TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON inspection_responsibility TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_group TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_group_commodity TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON article_72_commodities TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commodity_configuration TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON commoditycode_attributes TO commodity_admin_role;-->
<!--            GRANT ALL PRIVILEGES ON data_load TO commodity_admin_role;-->
<!--            -->
<!--            &#45;&#45; Schema and sequence permissions-->
<!--            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO commodity_admin_role;-->
<!--            ]]>-->
<!--        </sql>-->
<!--    </changeSet>-->

    <!-- View Permissions -->
    <changeSet id="postgresql-permissions-06-view-permissions" author="consolidated-migration">
        <sql dbms="postgresql">
            <![CDATA[
            -- Service role - SELECT on all views
            GRANT SELECT ON v_commodity_code TO trade-commodity-codes;
            GRANT SELECT ON v_commodity_category TO trade-commodity-codes;
            GRANT SELECT ON v_commodity_group TO trade-commodity-codes;
            GRANT SELECT ON v_chedpp_species TO trade-commodity-codes;
            GRANT SELECT ON v_chedp_species TO trade-commodity-codes;
            GRANT SELECT ON v_commodity_code_species TO trade-commodity-codes;
            GRANT SELECT ON v_data_load_status TO trade-commodity-codes;
            GRANT SELECT ON v_active_commodity_configurations TO trade-commodity-codes;
            GRANT SELECT ON v_active_commodity_attributes TO trade-commodity-codes;
            
            -- Admin role - ALL on all views
            GRANT ALL PRIVILEGES ON v_commodity_code TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_commodity_category TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_commodity_group TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_chedpp_species TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_chedp_species TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_commodity_code_species TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_data_load_status TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_active_commodity_configurations TO commodity_admin_role;
            GRANT ALL PRIVILEGES ON v_active_commodity_attributes TO commodity_admin_role;
            ]]>
        </sql>
    </changeSet>

    <!-- Function Permissions -->
    <changeSet id="postgresql-permissions-07-function-permissions" author="consolidated-migration">
        <sql dbms="postgresql">
            <![CDATA[
            -- Service role - EXECUTE on functions
            GRANT EXECUTE ON FUNCTION fn_commodity_category_data(VARCHAR, VARCHAR, VARCHAR) TO trade-commodity-codes;
            GRANT EXECUTE ON FUNCTION RIGHT(TEXT, INTEGER) TO trade-commodity-codes;
            GRANT EXECUTE ON FUNCTION fn_enhanced_commodity_category_data(VARCHAR, VARCHAR, VARCHAR) TO trade-commodity-codes;
            GRANT EXECUTE ON FUNCTION fn_get_commodity_hierarchy(VARCHAR) TO trade-commodity-codes;
            GRANT EXECUTE ON FUNCTION fn_validate_commodity_configuration(VARCHAR, VARCHAR) TO trade-commodity-codes;
            ]]>
        </sql>
    </changeSet>

    <!-- Default Permissions for Future Objects -->
    <changeSet id="postgresql-permissions-08-default-permissions" author="consolidated-migration">
        <sql dbms="postgresql">
            <![CDATA[
            -- Ensure roles get permissions on future tables
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO commodity_service_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO commodity_readonly_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO commodity_data_loader_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO commodity_admin_role;
            
            -- Ensure roles get permissions on future sequences
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO commodity_service_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO commodity_data_loader_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO commodity_admin_role;
            
            -- Ensure roles get permissions on future functions
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO commodity_service_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO commodity_readonly_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO commodity_data_loader_role;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON FUNCTIONS TO commodity_admin_role;
            ]]>
        </sql>
    </changeSet>

    <!-- Add role comments for documentation -->
    <changeSet id="postgresql-permissions-09-add-role-comments" author="consolidated-migration" dbms="postgresql">
        <sql>
            COMMENT ON ROLE commodity_service_role IS 'Main application service role with read access and limited update permissions';
            COMMENT ON ROLE commodity_data_loader_role IS 'ETL and data loading role with full DML permissions';
            COMMENT ON ROLE commodity_readonly_role IS 'Read-only role for reporting and analytics';
            COMMENT ON ROLE commodity_admin_role IS 'Database administration role with full permissions';
        </sql>
    </changeSet>

</databaseChangeLog>