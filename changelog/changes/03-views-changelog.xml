<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ============================================================================ -->
    <!-- PostgreSQL Consolidated Views Changelog -->
    <!-- ============================================================================ -->

    <!-- Main commodity code view -->
    <changeSet id="postgresql-views-01-create-commodity-code-view" author="consolidated-migration">
        <createView viewName="v_commodity_code">
            <![CDATA[
            SELECT 
                cn.traces_commodity_code AS code,
                CASE 
                    WHEN RIGHT(cn.sorting_key, 2) = '80' THEN RIGHT(cn.traces_commodity_code, 2)
                    ELSE ''
                END AS display_code,
                cn.traces_commodity_code_description AS description,
                CASE 
                    WHEN c.short_description = 'CVEDA' THEN 'CVED-A'
                    WHEN c.short_description = 'CVEDP' THEN 'CVED-P'
                    WHEN c.short_description = 'CED' THEN 'CED'
                    WHEN c.short_description = 'EUIA' THEN 'IMP'
                    WHEN c.short_description = 'CHED-PP' THEN 'CHED-PP'
                    ELSE c.short_description
                END AS cert_type,
                cr.traces_parent_code AS immediate_parent,
                CASE 
                    WHEN RIGHT(cn.sorting_key, 2) = '80' AND cr.is_selectable = TRUE THEN TRUE
                    ELSE FALSE
                END AS is_commodity,
                CASE 
                    WHEN EXISTS(
                        SELECT 1
                        FROM certification_requirement cr2
                        WHERE cr2.traces_parent_code = cn.traces_commodity_code
                        AND cr2.certification_requirement_code = cr.certification_requirement_code
                    ) THEN TRUE
                    ELSE FALSE
                END AS is_parent
            FROM commodity_nomenclature cn
            INNER JOIN certification_requirement cr
                ON cr.commodity_nomenclature_id_code = cn.code
            INNER JOIN certificates c
                ON c.code = cr.certification_requirement_code
            WHERE cr.is_traces_visible = TRUE
            ]]>
        </createView>
    </changeSet>

    <!-- Commodity category view -->
    <changeSet id="postgresql-views-02-create-commodity-category-view" author="consolidated-migration">
        <createView viewName="v_commodity_category">
            <![CDATA[
            SELECT 
                CASE 
                    WHEN c.short_description = 'CVEDA' THEN 'cveda'
                    WHEN c.short_description = 'CVEDP' THEN 'cvedp'
                    WHEN c.short_description = 'CED' THEN 'ced'
                    WHEN c.short_description = 'EUIA' THEN 'imp'
                    WHEN c.short_description = 'CHED-PP' THEN 'chedpp'
                    ELSE LOWER(c.short_description)
                END AS certificate_type,
                cn.traces_commodity_code AS commodity_code,
                fn_commodity_category_data(cr.code, c.code, cn.traces_commodity_code) AS data
            FROM commodity_nomenclature cn
            INNER JOIN certification_requirement cr
                ON cr.commodity_nomenclature_id_code = cn.code
            INNER JOIN certificates c
                ON c.code = cr.certification_requirement_code
            ]]>
        </createView>
     </changeSet>

    <!-- Commodity group view -->
    <changeSet id="postgresql-views-03-create-commodity-group-view" author="consolidated-migration">
        <createView viewName="v_commodity_group">
            <![CDATA[
            SELECT 
                cg.description AS commodity_group,
                cgc.traces_commodity_code AS traces_commodity_code
            FROM commodity_group cg
            INNER JOIN commodity_group_commodity cgc
                ON cg.code = cgc.commodity_group_code
            WHERE cg.is_deleted = FALSE 
                AND cgc.is_deleted = FALSE
            ]]>
        </createView>
    </changeSet>

    <!-- CHED-PP species view -->
    <changeSet id="postgresql-views-04-create-chedpp-species-view" author="consolidated-migration">
        <createView viewName="v_chedpp_species">
            <![CDATA[
            SELECT 
                cn.traces_commodity_code AS commodity_code,
                cert_nom.species_name,
                s.eppo_code,
                cert_nom.species_id,
                cn.traces_commodity_code_description AS commodity_description
            FROM certification_nomenclature cert_nom
            LEFT JOIN certification_requirement cert_req
                ON cert_req.code = cert_nom.certification_requirement_code
            LEFT JOIN species s
                ON s.code = cert_nom.species_code
            LEFT JOIN commodity_nomenclature cn
                ON cn.code = cert_req.commodity_nomenclature_id_code
            WHERE cert_nom.species_code IS NOT NULL
                AND cert_req.certification_requirement_code = '851'
            ]]>
        </createView>
    </changeSet>

    <!-- CHED-P species view -->
    <changeSet id="postgresql-views-05-create-chedp-species-view" author="consolidated-migration">
        <createView viewName="v_chedp_species">
            <![CDATA[
            SELECT 
                cn.traces_commodity_code AS commodity_code,
                cert_nom.species_name,
                cert_nom.commodity_type_name,
                cert_nom.class_name,
                cert_nom.family_name,
                cert_nom.species_id
            FROM certification_nomenclature cert_nom
            LEFT JOIN certification_requirement cert_req
                ON cert_req.code = cert_nom.certification_requirement_code
            LEFT JOIN species s
                ON s.code = cert_nom.species_code
            LEFT JOIN commodity_nomenclature cn
                ON cn.code = cert_req.commodity_nomenclature_id_code
            WHERE cert_nom.species_code IS NOT NULL
                AND cert_req.certification_requirement_code = '853'
            ]]>
        </createView>
    </changeSet>

    <!-- Commodity code species view (extended commodity view with species information) -->
    <changeSet id="postgresql-views-06-create-commodity-code-species-view" author="consolidated-migration">
        <createView viewName="v_commodity_code_species">
            <![CDATA[
            SELECT DISTINCT 
                cn.traces_commodity_code AS code,
                CASE 
                    WHEN RIGHT(cn.sorting_key, 2) = '80' THEN RIGHT(cn.traces_commodity_code, 2)
                    ELSE ''
                END AS display_code,
                cn.traces_commodity_code_description AS description,
                CASE 
                    WHEN c.short_description = 'CVEDA' THEN 'CVED-A'
                    WHEN c.short_description = 'CVEDP' THEN 'CVED-P'
                    WHEN c.short_description = 'CED' THEN 'CED'
                    WHEN c.short_description = 'EUIA' THEN 'IMP'
                    WHEN c.short_description = 'CHED-PP' THEN 'CHED-PP'
                    ELSE c.short_description
                END AS cert_type,
                cr.traces_parent_code AS immediate_parent,
                CASE 
                    WHEN RIGHT(cn.sorting_key, 2) = '80' AND cr.is_selectable = TRUE THEN TRUE
                    ELSE FALSE
                END AS is_commodity,
                CASE 
                    WHEN EXISTS(
                        SELECT 1
                        FROM certification_requirement cr2
                        WHERE cr2.traces_parent_code = cn.traces_commodity_code
                        AND cr2.certification_requirement_code = cr.certification_requirement_code
                    ) THEN TRUE
                    ELSE FALSE
                END AS is_parent,
                cert_nom.species_name AS species
            FROM commodity_nomenclature cn
            INNER JOIN certification_requirement cr
                ON cr.commodity_nomenclature_id_code = cn.code
            INNER JOIN certificates c
                ON c.code = cr.certification_requirement_code
            INNER JOIN certification_nomenclature cert_nom
                ON cert_nom.certification_requirement_code = cr.code
            WHERE cr.is_traces_visible = TRUE
            ]]>
        </createView>
    </changeSet>

<!--    &lt;!&ndash; Data load status view &ndash;&gt;-->
<!--    <changeSet id="postgresql-views-07-create-data-load-status-view" author="consolidated-migration">-->
<!--        <createView viewName="v_data_load_status">-->
<!--            <![CDATA[-->
<!--            SELECT -->
<!--                table_name,-->
<!--                file_name,-->
<!--                loaded,-->
<!--                CURRENT_TIMESTAMP - loaded AS age-->
<!--            FROM data_load-->
<!--            ORDER BY loaded DESC-->
<!--            ]]>-->
<!--        </createView>-->
<!--    </changeSet>-->

    <!-- Active commodity configurations view -->
    <changeSet id="postgresql-views-08-create-active-commodity-configurations-view" author="consolidated-migration">
        <createView viewName="v_active_commodity_configurations">
            <![CDATA[
            SELECT 
                cc.commodity_code,
                cc.type,
                cc.requires_test_and_trial,
                cc.finished_or_propagated,
                cn.traces_commodity_code_description AS description
            FROM commodity_configuration cc
            LEFT JOIN commodity_nomenclature cn
                ON cn.traces_commodity_code = cc.commodity_code
            ]]>
        </createView>
    </changeSet>

    <!-- Active commodity attributes view -->
    <changeSet id="postgresql-views-09-create-active-commodity-attributes-view" author="consolidated-migration">
        <createView viewName="v_active_commodity_attributes">
            <![CDATA[
            SELECT 
                ca.code,
                ca.traces_commodity_code,
                ca.commodity_type,
                ca.effective_from,
                ca.effective_to,
                cn.traces_commodity_code_description AS description
            FROM commoditycode_attributes ca
            LEFT JOIN commodity_nomenclature cn
                ON cn.traces_commodity_code = ca.traces_commodity_code
            WHERE ca.is_deleted = FALSE
                AND (ca.effective_to IS NULL OR ca.effective_to > CURRENT_TIMESTAMP)
            ]]>
        </createView>
    </changeSet>

    <!-- Create view comments for documentation -->
    <changeSet id="postgresql-views-10-add-view-comments" author="consolidated-migration" dbms="postgresql">
        <sql>
            COMMENT ON VIEW v_commodity_code IS 'Main commodity code view with certificate types and hierarchy';
            COMMENT ON VIEW v_commodity_category IS 'Commodity categories with JSON data for frontend consumption';
            COMMENT ON VIEW v_commodity_group IS 'Active commodity groups and their associated commodity codes';
            COMMENT ON VIEW v_chedpp_species IS 'CHED-PP specific species information';
            COMMENT ON VIEW v_chedp_species IS 'CHED-P specific species information with extended classification';
            COMMENT ON VIEW v_commodity_code_species IS 'Enhanced commodity view including species data';
--             COMMENT ON VIEW v_data_load_status IS 'Data loading audit and monitoring view';
            COMMENT ON VIEW v_active_commodity_configurations IS 'Currently active commodity configurations';
            COMMENT ON VIEW v_active_commodity_attributes IS 'Currently active commodity attributes';
        </sql>
    </changeSet>

</databaseChangeLog>